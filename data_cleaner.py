'''
Data Pre-processing
MF850 GroupProj

Silvia
'''

import pandas as pd
import numpy as np

def jintao_process(filename):
    Origin_data = pd.read_csv(filename)
    Origin_data.index = pd.to_datetime(Origin_data.date)
    Origin_data = Origin_data.drop(columns = ['date'])
    
    # Sorted dict
    ticker_list = [95073390517, 419090549363, 475789736474, 435350773146, 608129319963, 76574755044, 404755441537, 322903214132, 749318772299, 879350197848, 164276838742, 1091649811344, 81765788644, 839744223865, 862701054138, 12905909832, 991871592086, 168119817535, 917938181644, 652011962908, 1038336404293, 847001369019, 650077213918, 409131140030, 156065707995, 677979547315, 810244942521, 383749289344, 297452602249, 1044436602775, 635862418875, 1064835415386, 461395962721, 1037173924133, 944199736090, 615020170276, 653413069850, 513945858386, 259880487340, 54997863394, 518468660400, 422037873881, 869067683423, 579765168452, 25119965190, 608326709575, 20343730173, 103809792855, 1034552268795, 336248468832, 761643743615, 1007455881857, 1021746216238, 358656064839, 737141114109, 65605130475, 32748648516, 512837373135, 303344726775, 99046474865, 865813858862, 568260974794, 602900861000, 23312134580, 317605506857, 592109322253, 261455906956, 36653993893, 548749825205, 630614884947, 92820705232, 684775730674, 947954348058, 8616294116, 117336665984, 1009201168872, 274364449074, 804723294951, 794763586009, 431179655117, 984399393297, 493015587696, 269199445232, 692588966730, 321859195560, 589514707033, 167060091664, 765379960139, 393080352970, 399007601831, 543443979759, 601748971688, 823740361621, 986332212157, 610133797015, 596261217103, 1034256833048, 161469357949, 307101352138, 397032591437, 1011583358570, 543504284482, 578440144558, 95585453766, 44565255825, 15667765469, 560230431883, 152281517748, 1051329947736, 701909747556, 177912051170, 94494440135, 1012753860880, 223308447785, 216742242813, 339391630022, 500253825101, 241646907768, 704282191536, 318298040559, 516978063439, 107659847520, 792467863161, 357057780327, 185835567036, 149304239457, 1036593081851, 941303663125, 63846972223, 123044141611, 442414435103, 304422894650, 1072733333747, 765748490260, 645761953481, 137186942038, 1055620517446, 1022098006084, 652663835762, 153435310380, 818609003832, 135510456603, 133253039486, 332143863199, 917157366661, 195022558352, 561290419195, 257953807596, 633286711644, 356863811346, 817526654008, 318841578974, 351142558824, 564274304222, 130536721806, 699830515914, 598600101725, 962425720368, 688074047711, 1072138034687, 396499725283, 535295060735, 1013873997177, 849719332389, 602379301392, 1079534527252, 943053148712, 789141529611, 323424040066, 28474008953, 512807805439, 857566555376, 891597617394, 3454337628, 150014663848, 628568936842, 622183581010, 466773342132, 1022037496029, 501813378220, 93916567524, 504779876713, 1043145084265, 633774089935, 283712322600, 582399025585, 1045624164170, 1064586141288, 451089150815, 415360454939, 462540285534, 77935956823, 809983456533, 719275924144, 528195087952, 540258492215, 1000760555651, 347058046350, 535456751173, 507535921242, 310370701723, 74692655954, 781331669623, 720390733290, 784298409651, 1098312441359, 1055266899137, 479109661398, 789692920247, 42902116651, 416787756240, 546666268673, 638041917156, 377988921359, 551714324269, 52486056814, 106569259168, 944027830027, 1017943040813, 51126554626, 731464543441, 152699595614, 826786433994, 584236734503, 969726289330, 546808587338, 120665708125, 269774157364, 754541364504, 737171050413, 963071810653, 901823579217, 676751557655, 131218540170, 835744550306, 38518020516, 861619920903, 326301046096, 662445780039, 949598881965, 121311306026, 128702399195, 916986549721, 609021709462, 273680551176, 934244672929, 788134003356, 304604981763, 274325881121, 134099755110, 668239597892, 308606551681, 655970271837, 132012366524, 156903103003, 786327472409, 962364786886, 41225017110, 159191828112, 356083625459, 940436148708, 692612982489, 125305537399, 882540903027, 996974435693, 623090853622, 575748033990, 972759853182, 881405303850, 5809055981, 364853432019, 985103344220, 683643769833, 991752394282, 810432002857, 538055271285, 795633739573, 756558959809, 574222086438, 177399598600, 1047273570494, 405329830690, 1078859192694, 817320744165, 660744911155, 758306773449, 146690795644, 399197975436, 20464693057, 945512717847, 604097032359, 214526512641, 212610540773, 729385445056, 858399944562, 485379948605, 968596040824, 1090664368158, 709331011102, 758989009173, 576812166751, 3944633117, 196305297771, 508154268684, 1284008422, 297776855834, 225047494030, 402544922227, 620697246546, 1065426615108, 1014764746735, 882855926177, 593736346117, 396599284320, 660916960657, 30984980571, 493163467971, 238567592225, 984862019760, 377043588479, 652956440648, 150847141259, 375898097492, 698574122790, 6215254613, 1006322279038, 835786338730, 629000523113, 46284048709, 40466629666, 1080730977296, 889518167721, 252246185016, 382339086498, 812397589608, 874760980377, 480986660908, 1098644741861, 245562464521, 916993619454, 505024705064, 52467086000, 900553759088, 869331929086, 1064890845633, 945503759252, 315698623599, 449753447293, 962970583064, 256553089879, 924911150773, 10565770586, 212716224185, 262037974989, 140400878447, 17245353749, 703464894261, 250640092735, 609876276270, 474662595002, 1095942152647, 526302090081, 669905772872, 720759053383, 747056009945, 172796987365, 611667982389, 212872029875, 813459357613, 228116724389, 390255627943, 675248825595, 837504077316, 124873871793, 596197032557, 656209474060, 1051118226214, 890941373416, 596240768604, 34168011250, 561108681596, 649777194866, 47317128812, 549362936857, 472284461130, 994807556042, 625746806665, 50301967870, 685161981423, 689370420219, 377068532646, 4690628053, 7610776978, 1033254923159, 325502861485, 192892856184, 1060804107020, 1041167448534, 885448687500, 926014781057, 1015904850713, 223733575985, 394702830828, 982890891317, 927821078440, 705429896384, 578226594646, 221173634263, 1081952988400, 104058724392, 557359203964, 1093815599493, 1057329037011, 778416065674, 529101915739, 893341127711, 776811806770, 1027110126353, 737695415445, 147089836698, 80462563457, 904823670318, 903474288631, 407501834142, 72625568951, 604877110263, 143133746930, 543303435316, 750909254915, 765155225317, 945929883680, 187825239138, 737755981404, 555783047447, 346515410536, 373086777673, 339220675217, 898770311464, 209421271134, 252979917761, 872234433003, 501207470333, 1000610525471, 689454946620, 510532435040, 844406823359, 444017811195, 562271009914, 564791107119, 881605825378, 175216648081, 472405546403, 908900275221, 1032149324381, 1078941383329, 404103969089, 509014762369, 249216251753, 849844746695, 130366993204, 809760560733, 379717321638, 221380832112, 912301745075, 669823213529, 809364296050, 28355588705, 423680446728, 822378801264, 68620569107, 664913049585, 82011495034, 667883864589, 735068359566, 851497384941, 550572714449, 485934983695, 846835490465, 946307732636, 1044705689403, 825425071017, 1082334439970, 595442998521, 913502119329, 167604450707, 756831293106, 395502007041, 259129227587, 830779308017, 167680619376, 19079493102, 36668837684, 484419995029, 195407836625, 305015766753, 623657346517, 847300183898, 432884400743, 843916961504, 11330621402, 1022126413368, 460614898866, 577670075282, 63724604254, 35969156051, 667610466634, 1078944305346, 163934952279, 285508229797, 702330283101, 542511592918, 404873349660, 583115044339, 946103518628, 50864220354, 555017261827, 35782354379, 300081186160, 510737879219, 418060822956, 619086323483, 496283304456, 556116155035, 327242321124, 81963195220, 665383245072, 875044906917, 368791235873, 1025754084583, 847118865655, 903835470131, 776987084808, 347971969690, 740329217457, 934529135485, 824661455493, 177068310200, 216559356517, 585858989165, 264071392468, 1025496384069, 787947352498, 230983706261, 907391872390, 360261510507, 306889885964, 306187161287, 682884776465, 650578670966, 1007835756933, 112601970345, 1010427705149, 736734644929, 559215638812, 238399014032, 44763770652, 824382150829, 1042917321386, 907505938813, 880767048621, 255643005774, 6293162995, 641869027922, 1080908677508, 1013531905706, 382174714628, 735267790949, 122522295084, 578238846563, 205359499785, 82898884248, 882053115720, 958710469594, 853771243996, 169637057492, 121248270783, 147473886856, 858106279983, 394449330109, 836886720343, 1092605398637, 1003822660870, 902602129942, 676457714195, 183208318854, 374626490221, 624555582829, 881914421759, 909249375369, 1033123008211, 963717638135, 440810768566, 954823170234, 576053043116, 594669221419, 744151718211, 892963749575, 314592182166, 958135905334, 227019793586, 957653904101, 436353960560, 678068816257, 816982157847, 982799694152, 876901124219, 280861321973, 961892667822, 778447698519, 724963353316, 717384258383, 316007678919, 353439873336, 591490744125, 382462627200, 172775014918, 328375860548, 298410506220, 368419292434, 334358462536, 634414479003, 886178790311, 750379785402, 823205630417, 616253599499, 79660496147, 747018957654, 552056819701, 848080434909, 899920026307, 136777784003, 424984447448, 260481092963, 630047074338, 799556637169, 1061439896774, 403412180180, 25687627350, 601977719266, 363486436549, 408437287036, 368749372502, 65282190438, 598828562154, 455036051020, 22318149822, 145313798537, 407587863878, 293621991925, 647905925064, 1048236552541, 65628521000, 250483024465, 433315817284, 637801726782, 999010286133, 360925094713, 853342697329, 374624779366, 885690073178, 366846210192, 336017099839, 877205623740, 1066076694442, 411245815620, 733892907833, 411350647339, 1085799877874, 397152522235, 20016716161, 334107693303, 384750134988, 542619367985, 264419350586, 481728334189, 617588040430, 792981476621, 584381278365, 313311460563, 72078609030, 411432300820, 942669122533, 859306303293, 9286236765, 322663315248, 716558549152, 12187198889, 279972914298, 119335309641, 1056019936742, 517642622879, 125107543302, 558684166560, 271571651118, 23387832469, 828265819073, 1099322657542, 35077418662, 691228551590, 1066596369044, 693947439212, 595531031474, 940004943333, 713991626609, 557605605746, 639349083096, 17704128385, 219363910212, 22656252773, 269883237602, 688175442909, 630270100944, 463792662306, 777675810002, 790428757674, 362498217675, 416410571825, 8703565341, 666519170366, 295614892187, 387447454025, 938676022363, 234000879457, 455554564842, 507335606123, 868200908642, 406502006806, 404559484521, 264618388187, 50554502178, 943227920425, 215564417062, 495373418451, 50833640033, 507624076328, 480776677539, 731725552926, 628526059868, 556249820281, 834178959523, 221590974866, 587457888979, 75884364319, 397932825514, 961203288778, 953757674326, 143745152129, 263815826033, 32447656956, 341507153303, 232522430744, 857627508105, 627563036757, 4153685003, 1015340782841, 953510408629, 444241535908, 795230250122, 444437739384, 523550932982, 729819806316, 943734260989, 631460193482, 474076133766, 598354978602, 179087228353, 628925904885, 1065228712995, 303457464655, 739255955616, 622124385354, 1054351516120, 498859835592, 316558859715, 259747274423, 467767991625, 375436313529, 550858541592, 135453605594, 712877797594, 723377210253, 277723550503, 589062645283, 170495647736, 777030125805, 830118692902, 786594330757, 612556710917, 79562065926, 914731773320, 271453975732, 776716999076, 456889548170, 813643873840, 370845201700, 270353677887, 227727141442, 178229804825, 1044254444018, 600385710283, 712450769806, 85623287118, 591230791855, 532495631394, 212352971336, 922679711018, 329543582195, 416875475975, 249106903893, 633567361678, 746467797744, 73181124283, 1099349148516, 322473259941, 911342726870, 218727945346, 1055331907299, 563509535996, 325264217331, 154002916417, 350220290248, 32983057162, 853831991309, 875345580207, 912551795129, 725522432911, 618098569672, 933827226562, 357674128707, 156207722248, 359782059007, 338187574091, 832756684342, 887614507262, 494073168607, 400376771649, 119066008428, 418100046179, 695926637187, 198420419518, 888362536493, 868996651047, 921794882534, 970952119852, 917989954076, 681338068714, 836800931985, 744384699371, 473286961049, 588391769539, 1081875860635, 92407267908, 689353145954, 794137574896, 405386088522, 532883082498, 1069648185510, 1073685403197, 380314612547, 1040669615434, 309736868112, 206425834766, 310039813586, 1029005276895, 95174968743, 196197047445, 69406405107, 718215988190, 1068785240541, 688984261515, 833193159342, 941713866414, 656346212728, 624245040027, 61675877526, 235812436595, 1053780218018, 405687347174, 554718972673, 152516383158, 833440955470, 355109366953, 918241528661, 788029510256, 406777217128, 51403628512, 688644365548, 347266614279, 590520317126, 118209407969, 614747234609, 739600145002, 84927416871, 337937329569, 852766064889, 190827428100, 226604744006, 803953867589, 335524687854, 486978255419, 53114540772, 963486834025, 927616934163, 438377291177, 208512792452, 732871740262, 725644027808, 855317622328, 545074459888, 277710801049, 198412890529, 964733538807, 312156020024, 11382648318, 649159776938, 103023658838, 887397858696, 696809733716, 751119231675, 317798110320, 399692912085, 935795440688, 460563108673, 887913891679, 403419797927, 789153379301, 586436083446, 960792485258, 376486256218, 840424137891, 84793369853, 489043525896, 612326140603, 419159379575, 473067081357, 876101124740, 288770637447, 1098755820770, 175076747092, 314987423936, 378757411480, 686547732118, 337725504681, 745605799432, 486647754345, 834140617009, 603419098746, 1080076131807, 366023675678, 353123462083, 167332323330, 779572770145, 511450137100, 138149613827, 544530188722, 876218874840, 342437527240, 461671151812, 340987670961, 935491967999, 506813234847, 633876776054, 895557447794, 907689226317, 1016811668028, 1054798627212, 151746841951, 203380098474, 106302606011, 550608191451, 141686946774, 608011142350, 827723717824, 505418571691, 789868851796, 909396551051, 714757292376, 470544441770, 299573035454, 577556946924, 347447308530, 1050816396966, 744420423816, 350177648378, 480617896006, 858867951271, 531193155260, 969609570347, 286763906588, 276762453714, 710386473631, 344859606564, 282626137325, 819321922637, 901751944075, 670382202633, 509128092712, 1048459861300, 768442546461, 560193440322, 279874703961, 532240028252, 520525665206, 770789217227, 640742107128, 394901766863, 660749770521, 648487435492, 664866049797, 562687849050, 575060691618, 518854416304, 588958258099, 355727991407, 407213600607, 386320807406, 135497857318, 1078973366899, 503286655021, 494958882094, 583922260679, 1015788488711, 673258421469, 352801405580, 466445123516, 654034244720, 279649560080, 614411288969, 253748421476, 404325987938, 566327858928, 432149175853, 401285865181, 789270359021, 837725595429, 557941957462, 756773136677, 742181961802, 937118818489, 505518770880, 336610943306, 272575462215, 1062663253716, 630452665050, 555458740619, 903078371505, 687002873920, 211452170407, 557118540901, 936556961566, 175444012147, 831004928398, 218133123147, 838651376769, 875234407045, 811918851669, 182637493806, 50112246000, 208817460693, 572394077211, 453038524999, 473281239582, 930898443523, 497272424571, 904343383520, 873239014377, 666207257388, 925058794630, 330598829611, 224177161609, 1031489430232, 1042563618959, 748433554800, 448151448137, 787582196780, 326232640178, 682217063744, 521695275833, 319777839405, 892287724307, 1023731515713, 247244203240, 539875240206, 765173691131, 154893598484, 58718686049, 245862784249, 524271181445, 147479869349, 684266901260, 755970565501, 1017544880303, 636925149144, 301473142120, 1098381347737, 668236777601, 599830320017, 363032999527, 833933254375, 1076809593544, 1055067380312, 337191769089, 38921386553, 631675555840, 207995490689, 729433171947, 400635858194, 656374343574, 950919995714, 185521830075, 131240327095, 635767045191, 161668307448, 112426444312, 870808382314, 1048974323176, 766264498824, 860643238389, 22358262942, 829829425900, 1088475120800, 997324643007, 1057721999121, 865691298588, 30836785268, 561203391664, 330685756711, 963697870407, 454830099196, 200875553379, 473446615423, 8391403347, 1077855635354, 638767682418, 615343120375, 994543124376, 378001163586, 962038524627, 607994450625, 305045585648, 127947725835, 616808047921, 774915222877, 885852267918, 993907379005, 178634653747, 336320031548, 266484909712, 70317855801, 878356362727, 178875394385, 599946242591, 364576001271, 830524876734, 984400060707, 1053120093988, 749812713199, 764857198448, 54071869294, 115263645645, 261484786325, 938745056706, 704891050400, 952975609386, 1042205838381, 883558609105, 856151047805, 602567818245, 236753233962, 930800573683, 1076425810065, 662036626761, 406281230602, 797552699937, 1014755878025, 346812207042, 312649631882, 614292647263, 1098549719453, 552373796918, 645651676133, 269257445578, 192018698661, 32856765996, 2385191104, 167159536351, 615816000992, 245917890365, 324304154020, 243635283589, 1445319548, 768423195314, 778017464840, 949237860347, 72895974300, 423039892720, 990640715395, 477334901832, 653212362829, 108040134843, 178161610508, 188453397654, 620509854937, 171297836080, 862447613674, 388148720596, 804844730880, 18496279731, 871958416145, 180811401435, 984994520805, 642628173718, 297974348792, 1090925189642, 844771115694, 912635256668, 950162421856, 312573981437, 459432169606, 153832459150, 774849802209, 128450381195, 707977506736, 344913797676, 13426101149, 119509849454, 201842008441, 625846510594, 766794221307, 957782676960, 21596533492, 601604360863, 1049070605933, 923246999928, 81532168920, 169860616683, 718432000100, 525708767824, 767210827670, 333406405322, 298985773108, 682462347347, 562333139541, 449878372285, 78197592653, 778927105148, 602075616743, 296276773329, 23571244510, 607204321944, 234110054374, 642381607279, 561904652527, 803446028195, 538397353059, 811819522095, 867216347401, 728975370652, 445182074224, 282503268532, 568138316598, 533753002282, 543011629760, 782105918849, 1025857273212, 604347128622, 747555137471, 132114773534, 519364342802, 213740286492, 995669430035, 1065448807319, 738517377048, 49893885766, 127828042417, 454531994038, 570246257628, 577899952940, 11277676072, 712123034707, 896123342766, 15022666691, 659259970015, 35002386559, 939008136668, 921041220452, 478988331589, 1064621774803, 66453916791, 163400589902, 875854037156, 383618014410, 1042771785643, 1003485982192, 266587107551, 698745382389, 121726894894, 813752307645, 216505434584, 1018469544367, 955505431850, 100260665041, 273327897113, 375461991017, 287772567501, 639907401029, 936139319176, 526653795617, 950998487673, 516241794936, 270236548981, 598846847947, 21043867865, 419016282088, 716918228157, 705045657101, 849015954486, 708384598227, 589308934975, 966690575515, 519016475426, 685877269929, 738182499417, 477350729125, 501486539647, 474173334317, 247462240857, 110751656766, 974593204651, 112372096024, 845255297272, 842073065858, 679751350460, 889792919253, 474422711640, 982313749380, 422347371242, 533171501534, 851494966581, 376985487354, 258314880803, 580895666668, 352117004074, 812554026648, 624552606934, 1018963949967, 778680614494, 593968376195, 9099767093, 871484007790, 636579561098, 616703465019, 220305834541, 879675574676, 358804608079, 617609381044, 35362250650, 397617488004, 1095655593599, 988874491123, 399731131883, 512100212217, 871638753682, 597587568916, 75222211410, 322401361826, 111986915421, 70218777357, 847820169611, 113971876458, 828877515567, 59047465020, 901622110268, 468190809762, 811967212331, 1095299058761, 437388024676, 318158002334, 855336454632, 247308733632, 138797653622, 508570784319, 111769056906, 310592176054, 234534665135, 633041321222, 910905311160, 155749504217, 26064835364, 424504855522, 926867012890, 392755107931, 1040442114318, 194278244655, 226269755088, 1065303960604, 787384673663, 1078741885701, 583105630454, 975920077604, 103577214344, 1003450508477, 896607630623, 951094052234, 563686037977, 208066512636, 582477409766, 212592704990, 261062995006, 198960357972, 729917203969, 471275432386, 156785684850, 159130198817, 308040073472, 731659771709, 906628879012, 471362360173, 1037059194569, 763346317427, 724399155777, 857216125213, 105662553885, 680094524143, 818282157851, 869369602505, 508455506177, 799949457350, 916038706163, 561378248506, 673628788236, 1025103518660, 919761582225, 346646673460, 883517778856, 329924037305, 494994352469, 88479487576, 343257554707, 956134995228, 793022274973, 746581979873, 545126996135, 23055510874, 601684338081, 636060754139, 17973536537, 477439329024, 453012903848, 890575925868, 1072305861852, 813876876346, 136112125618, 567836474784, 987876507985, 752439283539, 1755285335, 95663156660, 202508804379, 435598942134, 271096127336, 119765697813, 472949502130, 638180032803, 1260512483, 762761379715, 474787413049, 167411094927, 412296092088, 657360795560, 704309277690, 1067274175204, 99165174613, 283055786198, 1012882384643, 542361694940, 21581146493, 97316704798, 485930732279, 445132955411, 71044469440, 998768429891, 168965819341, 344502949689, 947453430669, 977672887867, 45204539982]
    ticker_list.remove(977672887867)
    
    ticker_dict = {i:pd.DataFrame for i in ticker_list}
    for i in ticker_dict.keys():
        ticker_dict[i] = Origin_data[:][Origin_data.comp_id == i].sort_index()
    
    # add ROE, IA and size to each company data
    for i in ticker_list:
        ticker_dict[i]['ROE'] = (ticker_dict[i].ibq / ticker_dict[i].ceqq.shift(2) -1).fillna(method='backfill')
        ticker_dict[i]['IA'] = (ticker_dict[i].actq / ticker_dict[i].actq.shift(2)).fillna(method='backfill')
        ticker_dict[i]['size'] = (ticker_dict[i].close_adj * ticker_dict[i].m_volume_adj)/1000000
    
    final_df = ticker_dict[ticker_list[0]]
    for i in ticker_list[1:]:
        final_df = pd.concat([final_df,ticker_dict[i]])
    
    final_df = final_df.sort_values(by=['ggroup'])
    final_df = final_df.sort_index()
    
    adj_colum = final_df[['ROE','IA','size']]
    adj_colum = adj_colum.rename(columns={"ROE": "k_ROE", "IA": "k_IA", "size":"k_size"})
    
    for i in np.unique(adj_colum.index):
        if i == adj_colum.index[0]:
            aug = np.argsort(np.argsort(adj_colum.loc[i],axis=0),axis = 0)/len(ticker_list)*2
        else:
            aug = pd.concat([aug, np.argsort(np.argsort(adj_colum.loc[i],axis=0),axis = 0)/len(ticker_list)*2])
            
    final_df_aug = pd.concat([final_df, aug], axis=1)
    
    print("- %d tickers selected. m-factors added." %len(ticker_list))
    
    return final_df_aug

#%%

def get_cleaned_data(filename):
    
    print("\nStart Preprocessing for %s..."%filename)
    df = jintao_process(filename)
    
    # CHOOSE GOOD COLUMNS
    # zero_fill = ['cshopq','dd1q','xaccq','txpdy','xrdq','xintq']
    
    # Good columns: none of the company has all NAs
    good_cols = ['comp_id', 'close', 'm_volume', 'm_high', 'm_low', 'close_adj',
          'm_volume_adj', 'm_high_adj', 'm_low_adj', 'm_divs', 'm_ret', 'Bullish',
          'Neutral', 'Bearish', 'Bullish8WeekMovAvg', 'SP500WeeklyHigh',
          'SP500WeeklyLow', 'SP500WeeklyClose', 'fyearq', 'atq', 'ceqq', 'cheq',
          'chq', 'ciq', 'csh12q', 'cshfd12', 'cshfdq', 'cshprq', 'dlttq',
          'epsf12', 'epsfxq', 'epspxq', 'epsx12', 'ibadjq', 'ibcomq', 'ibmiiq',
          'ibq', 'intanq', 'loq', 'lseq', 'ltq', 'niq', 'nopiq', 'oiadpq', 'piq',
          'rdipq', 'revtq', 'xoprq', 'fincfy', 'ivncfy', 'oancfy', 'dvpspq',
          'dvpsxq', 'ggroup', 'gind', 'gsector', 'gsubind', 'sic', 'ROE', 'IA',
          'size', 'k_ROE', 'k_IA', 'k_size']# + zero_fill
    
    if 'm_ret_next' in df.columns:
        # if there is y column, drop na rows of it and add it to good_cols list
        df = df[df['m_ret_next'].notna()].copy()
        print("- NA rows for m_ret_next are dropped.")
        good_cols += ['m_ret_next']
    
    df = df[good_cols].copy()
    print("-", len(good_cols),"good columns selected.")
    
    # df[zero_fill] = df[zero_fill].fillna(0)
    
    # Ffill&Bfill ACCOUNTING DATA
    na_comp = pd.Series(df.comp_id.unique())
    na_comp = pd.Series(na_comp.map(lambda x: df[df.comp_id == x].isna().sum().sum()).values,
                         index = na_comp.values)
    
    na_compids = na_comp[na_comp > 0].index.tolist()
    good_compids = list(set(df.comp_id.unique()) - set(na_compids))
    
    dfs = []
    for cid in na_compids:
    
        cdf = df[df.comp_id == cid].copy()
        new_cdf = cdf.sort_values('date').fillna(method='ffill').fillna(method='bfill').copy()
        numna = new_cdf.isna().sum().sum()
        if numna > 0:
            print(cid, numna)
        dfs.append(new_cdf)
            
    togo_df = pd.concat(dfs, axis=0) # concat each new dfs
    df = df[df.comp_id.isin(good_compids)].append(togo_df).sort_index() # combine
    
    print("- Fill NA complete.")
    
    # TRADING INDICATORS
    
    # Add trading indicators which do not require lag
    
    # Close Location Value https://www.investopedia.com/terms/c/close_location_value.asp
    df['CLV'] = ((2*df.close - df.m_high - df.m_low)/(df.m_high - df.m_low)).fillna(0)
    df['CLV_adj'] = ((2*df.close_adj - df.m_high_adj - df.m_low_adj)/(df.m_high_adj - df.m_low_adj)).fillna(0)
    
    # Money Flow Volumn https://www.investopedia.com/terms/a/accumulationdistribution.asp
    df['MFV'] = df.CLV * df.m_volume
    df['MFV_adj'] = df.CLV_adj * df.m_volume_adj
    
    df['Range'] = df.m_high - df.m_low
    df['Range_adj'] = df.m_high_adj - df.m_low_adj
    
    print("- Trading indicators added.")
    
    # Final NA-drop 
    blen = len(df)
    df = df.dropna(axis=0)
    print("- Final NA-drop dropped %d rows"%(blen-len(df)))
    
    print("Data cleaning complete.")
    
    return df

#%%

if __name__ ==  "__main__":
    
    data_xy = get_cleaned_data("final_training_xy_2.csv")
    data = get_cleaned_data("final_training.csv")